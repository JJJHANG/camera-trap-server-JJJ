{% extends 'base/base.html' %}

{% load tag_library %}
{% load static %}
{% block title %}
search
{% endblock title %}

{% block script %}
<script src="{% static 'js/search.dev.js' %}"></script>

<script>
 const btnList = document.querySelectorAll(".check-form");
 btnList.forEach((x)=>{
   x.onclick = (e) => {
     e.preventDefault();
     const modal = document.getElementById("myModal");
     const textEle = document.getElementById("my-modal-text");
     const queryType = document.getElementById("query-type");
     const form = document.getElementById('my-form');
     modal.style.display = "block";
     //const text = (x.value == "query") ? "篩選中" : "計算中";
     //textEle.innnerHTML = `${text}...`;
     queryType.value = x.value;

     if (x.value === 'calculate') {
       const intervalSelect = document.getElementById('interval');
       const intervalSelect2 = document.getElementById('interval2');

       if (form.checkValidity()) {
         form.requestSubmit(); // won't process name=submit ?
       } else {
         form.classList.add('was-validated');
         modal.style.display = "none";
       }
     } else {
       form.requestSubmit();
     }
   }
 });

 let projectStudyareas = {% if project_deployment_list %}{{project_deployment_list|safe}}{% else %}null{% endif %};

 const handleProjectChange = () =>{
   const selectedProjectList = document.getElementById('project').selectedOptions;
   const studyareaEle = document.getElementById('studyarea');
   studyareaEle.innerHTML = '<option value="">---</option>';
   if (selectedProjectList.length == 1) {
     const projectId = selectedProjectList[0].value;
     fetch(`/api/client/v1/projects/${projectId}`)
       .then((resp) => resp.json())
       .then((jsonData) => {
         //console.log(jsonData)
         studyareaEle.innerHTML = '<option value="">---</option>';
         projectStudyareas = jsonData.studyareas;
         projectStudyareas.forEach((x)=>{
           const optionEle = document.createElement('option');
           optionEle.value = x.studyarea_id;
           optionEle.innerHTML = x.name;
           studyareaEle.appendChild(optionEle);
         });
       });
   }
 }
 const handleStudyareaChange = () =>{
   const studyareaId = document.getElementById('studyarea').value;
   if (studyareaId !== '') {
     if (projectStudyareas) {
       const found = projectStudyareas.find((x)=> parseInt(x.studyarea_id, 10) === parseInt(studyareaId, 10));
       if (found && found.deployments.length > 0) {
         const deploymentEle = document.getElementById('deployment');
         deploymentEle.innerHTML = '<option value="">---</option>';
         found.deployments.forEach((x)=>{
           const optionEle = document.createElement('option');
           optionEle.value = x.deployment_id;
           optionEle.innerHTML = x.name;
           deploymentEle.appendChild(optionEle);
         });
       }
     }
   }
 }

  console.log('debug query:', '{{ debug_query|safe}}' );
</script>
{% endblock %}

{% block style %}
    <style>
      .panel {
        position: relative;
        display: block;
        border: 1px solid #e9e9e9;
        background: #fff;
        -webkit-box-shadow: 0 2px 4px 0 rgb(170 191 181 / 30%);
        box-shadow: 0 2px 4px 0 rgb(170 191 181 / 30%);
        border-radius: 4px;
      }
     .panel .panel-body {
       padding: 20px 40px;
     }
     h3 {
       margin: 0 0 20px;
       font-size: 24px;
     }

     /*---*/
     /* The Modal (background) */
.my-modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

/* Modal Content/Box */
.my-modal-content {
  background-color: #fefefe;
  margin: 15% auto; /* 15% from the top and centered */
  padding: 20px;
  border: 1px solid #888;
  width: 200px; /* Could be more or less, depending on screen size */
}
    </style>
{% endblock %}

{% block body %}
<div class="container content">

<!-- The Modal -->
<div id="myModal" class="my-modal">
  <div class="my-modal-content">
    <div class="spinner-border" role="status">
      <span class="sr-only"></span>
    </div>
    <span id="my-modal-text" style="margin-left:6px;">Loading...</span>
  </div>
</div>
<!-- end The Modal -->

{% include "./inc_calculate_description.html" %}

  <div class="row" style="margin-bottom: 10px">
    <h4 class="title-dark p-0">資料篩選計算</h4>
  </div>
  <div class="panel">
    <div class="panel-body">
      <div id="app-search"></div>
    </div>
  </div>
</div>
{% endblock %}
