{% extends 'base/base.html' %}
{% block style %}
    <style>
        .clickable-row {
            cursor: pointer;
        }

        .table {
            padding: 1% 0;
        }
          
        .nav-link {
            color: gray;
        }

        .nav-link:hover {
            color: lightgrey;
        }

        .page-item.active .page-link {
            background-color: rgb(228, 224, 224) !important;
            border: 1px solid rgb(228, 224, 224) ;
        }
        .page-link {
            color: black !important;
        }
        
        /* radio style */
        input[type="radio"] {
            display: none
        }

        label {
            cursor: pointer
        }
    </style>
{% endblock style %}
{% block body %}
{% csrf_token %}
<div class="container content">
    <div class="row" style="margin-bottom: 10px">
            <h4 class="title-dark p-0">計畫總覽</h4>
    </div>
    <div class="row">
        <div class="col-2 bg-white">
            <div class="row">
                <p class="mt-3 d-flex justify-content-between">篩選條件
                    <button style="font-size: 14px" class="btn btn-light p-0" onClick="Clear()">清除 －</button>
                </p>
                <hr style='margin: auto; width: 90%'>
                <p class="mt-3 mb-1">
                    <strong>物種</strong> 
                </p>
                <ul id="species-list" style="list-style: none">
                    {% for i in public_species_data %}
                    <li class="public-species">
                        <label class="form-check-label">
                        <input class="filter"  type="radio" group="species" name="species-filter" value="{{ i.1 }}">
                            {{ i.1 }} ({{i.0}})
                        </label>
                    </li>
                    {% endfor %}
                    {% for i in my_species_data %}
                    <li class="my-species d-none">
                        <label class="form-check-label">
                        <input class="filter"  type="radio" group="species" name="species-filter" value="{{ i.1 }}">
                            {{ i.1 }} ({{i.0}})
                        </label>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <div class="col-10">
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="publicproject-tab" data-bs-toggle="tab" data-bs-target="#publicproject" type="button" role="tab" aria-controls="publicproject" aria-selected="false">公開計畫</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="myproject-tab" data-bs-toggle="tab" data-bs-target="#myproject" type="button" role="tab" aria-controls="myproject" aria-selected="true">我的計畫</button>
                </li>
                <li class="nav-item ms-auto">
                    <a class="btn btn-orange" href="{% url 'create_project' %}">新增計畫</a>
                </li>
            </ul>
              <div class="tab-content" id="myTabContent" style="background-color: white; padding: 2%">
                <div class="tab-pane fade" id="myproject" role="tabpanel" aria-labelledby="myproject-tab">
                    {% if request.session.is_login == True %}
                    <table class="table table-hover bg-white" id="myproject-table" style="width: 100%;">
                        <thead>
                        <tr>
                            <td style="width: 33%">計畫名稱</td>
                            <td style="width: 12%">計畫關鍵字</td>
                            <td style="width: 10%">資料起始年份</td>
                            <td style="width: 15%">委辦單位</td>
                            <td style="width: 10%">樣區數量</td>
                            <td style="width: 10%">相機位置數</td>
                            <td style="width: 10%">資料量</td>
                        </tr>
                        </thead>
                        <tbody id="myproject-tbody">
                        {% for tuples in my_project %}
                            <tr class='clickable-row' data-href="{% url 'project_detail' tuples.0 %}">
                                {% for t in tuples %}
                                    {% if not forloop.first %}
                                        {% if t == 'None' %}
                                            <td></td>
                                        {% else %}
                                            <td>{{ t }}</td>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    請先登入後查看您的計畫
                    {% endif %}

                </div>
                <div class="tab-pane fade show active" id="publicproject" role="tabpanel" aria-labelledby="publicproject-tab">
                    <table class="table table-hover bg-white" id="publicproject-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <td style="width: 33%">計畫名稱</td>
                                <td style="width: 12%">計畫關鍵字</td>
                                <td style="width: 10%">起始年份</td>
                                <td style="width: 15%">委辦單位</td>
                                <td style="width: 10%">樣區數量</td>
                                <td style="width: 10%">相機位置數</td>
                                <td style="width: 10%">資料量</td>
                            </tr>
                        </thead>
                        <tbody id="publicproject-tbody">
                        {% for tuples in public_project %}
                            <tr class='clickable-row' data-href="{% url 'project_detail' tuples.0 %}">
                                {% for t in tuples %}
                                    {% if not forloop.first %}
                                        {% if t == None %}
                                            <td></td>
                                        {% else %}
                                            <td>{{ t }}</td>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
              </div>
        </div>
    </div>
    </div>
{% endblock body %} {% block script %}
    <script>
        var $crf_token = $('[name="csrfmiddlewaretoken"]').attr('value');

        $(function () {

            // speices filter list
            $('#publicproject-tab').on('click', function(){
                $('.public-species').removeClass('d-none')
                $('.my-species').addClass('d-none')
            })

            $('#myproject-tab').on('click', function(){
                $('.my-species').removeClass('d-none')
                $('.public-species').addClass('d-none')
            })

            // clickable datatable
            $("#myproject-table").on("click", ".clickable-row", function(){
                window.location = $(this).data("href");            
                });

            $("#publicproject-table").on("click", ".clickable-row", function(){
                window.location = $(this).data("href");
            });

            // filter data by species
            $("#species-list").on("click", ".filter", function(){

                check_list = $("[name=species-filter]:checked");

                let speciesArray = [];
                check_list.each(function(){
                    speciesArray.push($(this).val()); 
                });
                if (speciesArray.length){
                    // current table
                    table_id = $('.col-10 .active').attr('aria-controls')

                    $.ajax({
                        type: 'POST',
                        url: "{% url 'update_datatable' %}",
                        data: {'table_id': table_id, 'species': speciesArray},
                        headers:{"X-CSRFToken": $crf_token},
                        success: function (response) {
                            // reset table
                            $('#'+table_id+'-table').DataTable().destroy()
                            $('#'+table_id+'-tbody').html('')
                            let i;
                            for (i = 0; i < response.length; i++) {
                                // keyword & funding agency
                                if (response[i][2] == 'None'){
                                    response[i][2] = ''
                                }

                                if (response[i][4] == 'None'){
                                    response[i][4] = ''
                                }

                            $('#'+table_id+'-tbody').append(`
                                <tr class='clickable-row' data-href="details/${response[i][0]}/">
                                    <td>${response[i][1]}</td>
                                    <td>${response[i][2]}</td>
                                    <td>${response[i][3]}</td>
                                    <td>${response[i][4]}</td>
                                    <td>${response[i][5]}</td>
                                    <td>${response[i][6]}</td>
                                    <td>${response[i][7]}</td>
                                </tr>`)
                            }
                            $('#'+table_id+'-table').DataTable({"language": language_settings});

                        },
                    })
                }
            })

        });

        function Clear(){
            // reset table
            $('#species-list').html(`
                    {% for i in public_species_data %}
                    <li class="public-species">
                        <label class="form-check-label">
                        <input class="filter"  type="radio" group="species" name="species-filter" value="{{ i.1 }}">
                            {{ i.1 }} ({{i.0}})
                        </label>
                    </li>
                    {% endfor %}
                    {% for i in my_species_data %}
                    <li class="my-species d-none">
                        <label class="form-check-label">
                        <input class="filter"  type="radio" group="species" name="species-filter" value="{{ i.1 }}">
                            {{ i.1 }} ({{i.0}})
                        </label>
                    </li>
                    {% endfor %}
            `)

            $('#myproject-table').DataTable().destroy();
            $('#publicproject-table').DataTable().destroy();

            $('#myproject-tbody').html(
                `{% for tuples in my_project %}
                    <tr class='clickable-row' data-href="{% url 'project_detail' tuples.0 %}">
                        {% for t in tuples %}
                            {% if not forloop.first %}
                                {% if t == None %}
                                    <td></td>
                                {% else %}
                                    <td>{{ t }}</td>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    </tr>
                {% endfor %}`
            )

            $('#publicproject-tbody').html(
                `{% for tuples in public_project %}
                    <tr class='clickable-row' data-href="{% url 'project_detail' tuples.0 %}">
                        {% for t in tuples %}
                            {% if not forloop.first %}
                                {% if t == None %}
                                    <td></td>
                                {% else %}
                                    <td>{{ t }}</td>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    </tr>
                {% endfor %}`
            )

            $('#myproject-table').DataTable({"language": language_settings});
            $('#publicproject-table').DataTable({"language": language_settings});

            // filter
            table_id = $('.col-10 .active').attr('aria-controls')
            if (table_id == 'myproject'){
                $('.my-species').removeClass('d-none')
                $('.public-species').addClass('d-none')
            } else {
                $('.my-species').addClass('d-none')
                $('.public-species').removeClass('d-none')
            }

        }

        // datatable
        let language_settings = {
            "decimal":        "",
            "emptyTable":     "查無資料",
            "info":           "共 _TOTAL_ 筆",
            "infoEmpty":      "共 0 筆",
            "infoFiltered":   "",
            "infoPostFix":    "",
            "thousands":      ",",
            "lengthMenu":     "每頁顯示 _MENU_ 筆",
            "loadingRecords": "載入中...",
            "processing":     "處理中...",
            "search":         "查詢🔍",
            "zeroRecords":    "查無符合資料",
            "paginate": {
                "next":       "下一頁",
                "previous":   "上一頁"
            }
        };

        $('#myproject-table').DataTable({"language": language_settings});
        $('#publicproject-table').DataTable({"language": language_settings});

    // radio style
    $("input[type=radio]").click( function () {
        let group = $(this).attr('name')
        $(`input[name=${group}]`).parent('label').children('i').remove()
        $('<i class="fas fa-check title-dark"></i>').insertBefore(this);
    });

    </script>
{% endblock script %}
