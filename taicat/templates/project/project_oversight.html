{% extends 'base/base.html' %}

{% block title %}
{{ project_info.0 }} | {{ block.super }}
{% endblock title %}

{% load static %}
{% load tag_library %}

{% block head %}
<!-- link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta2/dist/css/bootstrap-select.min.css"-->
<style>
    /* datatable loader */
    .dataTables_wrapper .dataTables_processing {
        content: '';
        position: absolute;
        width: 100%;
        min-height: 150px;
        height: 150px;
        left: 0;
        right: 0;
        margin: auto;
        background: url("{% static  'icon/Leaves-1.8s-200px.gif' %}") no-repeat center;
        background-size: 150px;
        z-index: 1099;
        border: 0
    }

    .dataTables_wrapper .dataTables_processing:after {
        content:'處理中';
        position: absolute;
        top: 160px;
        bottom: 0;
        left: 0;
        right: 0;
        color: rgb(37, 116, 85);
        width: 100px;
        height: 20px;
        margin: auto;
        z-index: 1199;
        text-align: center;
    }

    /* datatable page button */
    .page-item.active .page-link {
        background-color: rgb(228, 224, 224) !important;
        border: 1px solid rgb(228, 224, 224) ;
    }
    .page-link {
        color: black !important;
    }

    .dataTables_wrapper {
        background-color: white
    }

    #img-table {
        margin: 0 auto
    }

    #img-table_wrapper {
        box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);
    }

    .oversight:hover {
        color: lightgrey;
    }

    .back:hover {
        color: lightgrey;
    }

    .btn-new {
        background-color: white;
        border: 1px solid #cccccc;
        color: black !important;
    }

    .ui-autocomplete { 
        z-index:2147483647; 
        max-height: 200px;
        overflow-y: auto;
        /* prevent horizontal scrollbar */
        overflow-x: hidden;
        /* add padding to account for vertical scrollbar */
        padding-right: 20px;
    }

    /* radio style */
    input[type="radio"] {
        display: none
    }

    label {
        cursor: pointer
    }

    /* window size */

    .header {
        height: 70px
    }

    .remain.col-2{
        overflow-y: scroll;
        height:calc(100vh - 126px);
        background-color: yellow;
        }


    .remain.col-10{
        position: relative;
        height:calc(100vh - 126px);
    }

    footer {
        display: none
    }
    
    /* studyarea */
    .studyarea-list-area ul {
        padding: 0;
        list-style: none;
    }

   .studyarea-list-area li {
        padding: 15px 0 ;
        cursor: pointer
    }

    /* sub studyarea */
    .collapse > li {
        margin-left: 10%
    }

    .collapse-s > li {
        margin-left: 20%
    }

    /* font small */
    .font-sm {
        font-size: 15px
    }

</style>
{% endblock head %}

{% block script %}
<script>
$(function () {
   $('[data-toggle="tooltip"]').tooltip()
   $('.month-detail').click((e)=>{
     const data = JSON.parse(e.target.dataset.detail);
     //console.log(data);
     $('#detail-modal-title').html(`${data[0]}年${data[1]}月 | 相機位置: ${data[2]}`);
     $('#detail-modal-tbody').empty();
     $('#detail-modal-list').empty();
     $('#detail-modal-count').html(data[3]);
     $('#detail-modal-days').html(data[4]);
     $('#detail-modal-ratio').html((data[3] * 100.0 / data[4]).toFixed(2));
     for (let i=0; i<data[5].length; i++) {
       let cols = '';
       for (let j=0; j<data[5][i].length; j++) {
         let day = '';
         let cls = 'table-light';
         if (data[5][i][j] > 0) {
           day = data[5][i][j];
           cls = (data[6][day-1] > 0) ? 'table-success' : 'table-danger';
         } else {
           day = '';
         }
         cols += `<td class="${cls}">${day}</div></td>`;
       }
       $('#detail-modal-tbody').append(`<tr>${cols}</tr>`);
     }
     for (let i=0; i<data[7].length; i++) {
       $('#detail-modal-list').append(`<li class="list-group-item">${data[7][i][0]} ~ ${data[7][i][1]}</li>`);
     }

   });
 })
</script>
{% endblock %}
{% block body %}

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detail-modal-title">--</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        綠底: 有運作、紅底: 無運作
        <table class="table">
          <thead>
            <tr><th>一</th><th>二</th><th>三</th><th>四</th><th>五</th><th>六</th><th>日</th></tr>
          </thead>
          <tbody id="detail-modal-tbody">
          </tbody>
        </table>
        <div>
          行程紀錄
          <ul class="list-group" id="detail-modal-list">
          </ul>
        </div>
        <div>相機運作比例 <span id="detail-modal-ratio"></span> (相機有運作天數 <span id="detail-modal-count"></span> / 當月天數 <span id="detail-modal-days"></span>)</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>
<!-- end Modal -->

<div class="container box">
  <div class="row pb-2 pt-4 header overflow-auto">
        <div class="col-12">
            <a class="text-gray back text-decoration-none align-middle" href="/project/details/{{ project.id }}/"><i class="fa fa-chevron-left" aria-hidden="true"></i> 返回計畫 ({{ project.name }})</a>
        </div>
    </div>
  <div class="row">
    <div class="col-12">
      <h4 class="title-dark p-0">
            相機樣點運作及缺失比例
      </h4>

      <div>
        <h4>年份</h4>
        <h6>所有照片</h6>
      {% for i in year_list %}
      {% if i|to_int == request.GET.year|to_int %}
      {{ i }}
      {% else %}
      <a href="{% url 'project_oversight' pk=project.id %}?year={{ i }}">{{ i }}</a>
      {% endif %}
      {% if not forloop.last %} | {% endif %}
      {% endfor %}
      <hr>
      <h6>行程篩選</h6>
      {% for i in year_list2 %}
      {% if i|to_int == request.GET.year|to_int %}
      {{ i }}
      {% else %}
      <a href="{% url 'project_oversight' project.pk %}?year={{ i }}">{{ i }}</a>
      {% endif %}
      {% if not forloop.last %} | {% endif %}
      {% endfor %}
      </div>
      <hr>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <h4>每月相機運作比例</h4>
      <div>每一格數字代表: 每月相機運作時數(%) | 物種表示比例(%) (有標物種的照片/全部照片)</div>
      {% for studyarea in result %}
      <h5>樣區: {{ studyarea.name }}</h5>
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th scope="col">相機位置</th>
            {% for m in month_label_list %}
            <th scope="col">{{ m }}</th>
            {% endfor %}
            <th scope="col">平均</th>
          </tr>
        </thead>
        <tbody>
          {% for deployment in studyarea.items %}
              <tr>
                <th scope="row">{{ deployment.name }}</th>
                {% for x in deployment.items %}
                <td>{#<span data-toggle="tooltip" data-placement="bottom" title="{{ x.1.0 }}/{{ x.1.1 }} （相機有運作天數 / 當月天數）<br/>{{ x.1.2 }}" data-bs-html="true">{{ x.0|floatformat:2 }}%</span>#}<button type="button" class="btn month-detail"data-bs-toggle="modal" data-bs-target="#exampleModal" data-detail="{{ x.1 }}">{{ x.0|floatformat:2 }} <br /> {{ x.2.0|floatformat:2 }}{% if x.2.0 > 0 %}<br/><small>({{ x.2.1}} / {{ x.2.2 }})</small>{% endif %}</button></td>
                {% endfor %}
                <td>{{ deployment.ratio_year|floatformat:2  }}</td>
              </tr>
              {% endfor %}
          </tbody>
      </table>
      {% endfor %}
      <a href="{% url 'download_project_oversight' pk=project.id %}" class="btn btn-success">管考表下載</a>
    </div>
</div>
{% endblock %}
